## ä½¿ç”¨ PyEDB è‡ªå‹•åŒ– ANSYS EDB çš„ PCB å †ç–Šç®¡ç†

### âœ… **1. è§’è‰²èˆ‡æ ¸å¿ƒç›®æ¨™**

æ‚¨æ˜¯ä¸€ä½è³‡æ·±çš„ PCB æ¨¡æ“¬è‡ªå‹•åŒ–å·¥ç¨‹å¸«ã€‚æ‚¨çš„æ ¸å¿ƒç›®æ¨™æ˜¯åˆ©ç”¨ `pyedb`ï¼ˆANSYS EDB Python APIï¼‰ç¨‹å¼åº«ï¼Œé–‹ç™¼ä¸€å¥— Python å·¥ä½œæµç¨‹ï¼Œä»¥**è‡ªå‹•åŒ– PCB å †ç–Šï¼ˆStackupï¼‰è³‡è¨Šçš„åŒ¯å‡ºèˆ‡åŒ¯å…¥**ã€‚

æ­¤æµç¨‹æ—¨åœ¨è§£æ±ºä»¥ä¸‹ç—›é»ï¼š
* **æ•ˆç‡ä½ä¸‹**ï¼šå–ä»£æ‰‹å‹•åœ¨ GUI ä¸­é€å±¤è¼¸å…¥åƒæ•¸çš„é‡è¤‡æ€§å·¥ä½œã€‚
* **æ˜“æ–¼å‡ºéŒ¯**ï¼šæ¸›å°‘äººå·¥è¼¸å…¥éŒ¯èª¤çš„é¢¨éšªã€‚
* **ç‰ˆæœ¬æ§åˆ¶**ï¼šå°‡è¤‡é›œçš„å †ç–Šè¨­å®šå­˜æª”æ–¼æ˜“æ–¼ç®¡ç†çš„ Excel è¡¨æ ¼ä¸­ï¼Œæ–¹ä¾¿è¿½è¹¤èˆ‡æ¯”è¼ƒã€‚
* **åœ˜éšŠå”ä½œ**ï¼šè®“ä¸ç†Ÿæ‚‰ ANSYS å·¥å…·çš„ææ–™æˆ–ä½ˆå±€å·¥ç¨‹å¸«ä¹Ÿèƒ½é€é Excel ä¿®æ”¹å †ç–Šåƒæ•¸ã€‚

---

### ğŸ§  **2. ä»»å‹™ç¸½è¦½**

è«‹æ’°å¯«ä¸‰æ”¯ç¨ç«‹ä½†ç›¸äº’é—œè¯çš„ Python ç¨‹å¼ï¼š
1.  **`export_stackup_to_excel.py`**: å¾ `.brd` æª”æ¡ˆè®€å–è¨­è¨ˆï¼Œä¸¦å°‡å…¶å®Œæ•´çš„å †ç–Šè³‡è¨ŠåŒ¯å‡ºè‡³æ ¼å¼åŒ–çš„ Excel æª”æ¡ˆã€‚
2.  **`import_stackup_from_excel.py`**: è®€å–ä¸Šè¿° Excel æª”æ¡ˆï¼Œä¸¦å°‡å…¶ä¸­å®šç¾©çš„åƒæ•¸æ›´æ–°å› AEDB å°ˆæ¡ˆã€‚
3.  **`test_excel_to_aedb.py`**: å»ºç«‹ä¸€å€‹è‡ªå‹•åŒ–æ¸¬è©¦ï¼Œé©—è­‰æ•´å€‹åŒ¯å‡º-ä¿®æ”¹-åŒ¯å…¥æµç¨‹çš„æ­£ç¢ºæ€§èˆ‡å¯é æ€§ã€‚

---

### ğŸ“‹ **3. è©³ç´°ä»»å‹™éœ€æ±‚**

#### **ğŸ”¹ è…³æœ¬ 1: `export_stackup_to_excel.py` (åŒ¯å‡ºè‡³ Excel)**

* **ç›®çš„**: å»ºç«‹ä¸€å€‹å¯ä¾›äººé¡é–±è®€å’Œç·¨è¼¯çš„å †ç–Šå ±å‘Šã€‚
* **åŸ·è¡Œæµç¨‹**:
    1.  æ¥æ”¶ä¸€å€‹ `.brd` æª”æ¡ˆè·¯å¾‘ä½œç‚ºè¼¸å…¥ã€‚
    2.  ä½¿ç”¨ `edb = Edb(brd_path, edbversion='2024.1')` åˆå§‹åŒ–ä¸¦å»ºç«‹ä¸€å€‹ `.aedb` å°ˆæ¡ˆã€‚
    3.  éæ­·å †ç–Šä¸­çš„æ¯ä¸€å±¤ï¼Œä¸¦æ“·å–ä¸‹è¡¨æ‰€åˆ—çš„åƒæ•¸ã€‚
    4.  å°‡æ•¸æ“šå¯«å…¥åç‚º `stackup_report.xlsx` çš„ Excel æª”æ¡ˆã€‚
* **Excel è¼¸å‡ºè¦æ ¼**:

| æ¬„ä½åç¨± (Header)                 | å…§å®¹æè¿°                                                              | æ ¼å¼åŒ–è¦å‰‡                                                                                                    |
| --------------------------------- | --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| `Layer Name`                      | å±¤çš„åç¨±ã€‚                                                            | -                                                                                                             |
| `Layer Type`                      | å±¤çš„é¡å‹ (e.g., `signal`, `dielectric`)ã€‚                             | -                                                                                                             |
| `Thickness`                       | å±¤çš„åšåº¦ã€‚                                                            | å…è¨±ä½¿ç”¨è€…é€éåƒæ•¸æŒ‡å®šè¼¸å‡ºå–®ä½ç‚º `mil` æˆ– `mm`ã€‚                                       -                                                                                                             |
| `Dielectric Constant (Dk)`        | ææ–™çš„ä»‹é›»å¸¸æ•¸ ($D_k$)ã€‚                                                | è‹¥ `Layer Type` ç‚º `signal` æˆ– `conductor`ï¼Œæ­¤æ¬„ä½æ‡‰ç‚º**ç©ºå€¼**ï¼Œä¸”å„²å­˜æ ¼èƒŒæ™¯æ‡‰**å¡«æ»¿é»‘è‰²**ã€‚              |
| `Loss Tangent (Df)`               | ææ–™çš„æè€—è§’æ­£åˆ‡ ($D_f$)ã€‚                                              | è‹¥ `Layer Type` ç‚º `signal` æˆ– `conductor`ï¼Œæ­¤æ¬„ä½æ‡‰ç‚º**ç©ºå€¼**ï¼Œä¸”å„²å­˜æ ¼èƒŒæ™¯æ‡‰**å¡«æ»¿é»‘è‰²**ã€‚              |
| `Conductivity`                    | å°é›»ç‡ (S/m)ã€‚                                                        | è‹¥ `Layer Type` ç‚º `dielectric`ï¼Œæ­¤æ¬„ä½æ‡‰ç‚º**ç©ºå€¼**ï¼Œä¸”å„²å­˜æ ¼èƒŒæ™¯æ‡‰**å¡«æ»¿é»‘è‰²**ã€‚                       |
| `Etching Factor`                  | è•åˆ»å› å­ã€‚                                                            | è‹¥ `Layer Type` ç‚º `dielectric`ï¼Œæ­¤æ¬„ä½æ‡‰ç‚º**ç©ºå€¼**ï¼Œä¸”å„²å­˜æ ¼èƒŒæ™¯æ‡‰**å¡«æ»¿é»‘è‰²**ã€‚å¦‚æœè®€å–å€¼ç‚º 0ï¼Œå‰‡é¡¯ç¤º 0ã€‚ |
| `Top/Bottom/Side Nodule Radius (Âµm)` | Huray ç²—ç³™åº¦æ¨¡å‹çš„**ç¯€é»åŠå¾‘**ï¼Œå–®ä½ç‚ºå¾®ç±³ ($Âµm$)ã€‚åˆ†ä¸‰åˆ—ã€‚       | åŒ `Etching Factor`ã€‚                                                                                         |
| `Top/Bottom/Side Surface Ratio`   | Huray ç²—ç³™åº¦æ¨¡å‹çš„**è¡¨é¢ç²—ç³™ä¿‚æ•¸**ã€‚åˆ†ä¸‰åˆ—ã€‚                          | åŒ `Etching Factor`ã€‚                                                                                         |

---

#### **ğŸ”¹ è…³æœ¬ 2: `import_stackup_from_excel.py` (å¾ Excel åŒ¯å…¥)**

* **ç›®çš„**: æ ¹æ“šä¿®æ”¹å¾Œçš„ Excel å ±å‘Šï¼Œè‡ªå‹•æ›´æ–° AEDB å°ˆæ¡ˆã€‚
* **åŸ·è¡Œæµç¨‹**:
    1.  æ¥æ”¶ä¸€å€‹ç¾æœ‰çš„ `.aedb` å°ˆæ¡ˆè·¯å¾‘å’Œ `stackup_report.xlsx` è·¯å¾‘ä½œç‚ºè¼¸å…¥ã€‚
    2.  è®€å– Excel è¡¨æ ¼ä¸­çš„æ•¸æ“šã€‚
    3.  å°æ¯ä¸€å±¤ï¼ˆä»¥ `Layer Name` ç‚ºç´¢å¼•ï¼‰åŸ·è¡Œä»¥ä¸‹æ›´æ–°é‚è¼¯ï¼š
        * **åšåº¦**: æ ¹æ“š Excel ä¸­çš„ `Thickness` å’Œ `Thickness Unit` æ¬„ä½ï¼Œå°‡å€¼è½‰æ›ç‚ºå…¬å°ºï¼ˆmeterï¼‰å¾Œæ›´æ–° `layer.thickness`ã€‚
        * **ææ–™ (Dielectric)**:
            a. æ ¹æ“šè©²å±¤çš„ $D_k$ å’Œ $D_f$ å€¼ï¼Œç”¢ç”Ÿä¸€å€‹æ¨™æº–åŒ–çš„ææ–™åç¨±ï¼Œæ ¼å¼ç‚º `m_<dk>_<df>` (ä¾‹å¦‚ `m_4.1_0.02`)ã€‚
            b. æª¢æŸ¥æ­¤ææ–™æ˜¯å¦å­˜åœ¨æ–¼ AEDB å°ˆæ¡ˆä¸­ã€‚
            c. è‹¥ä¸å­˜åœ¨ï¼Œå‰‡ä½¿ç”¨ `edb.materials.add_dielectric_material()` å»ºç«‹æ–°ææ–™ã€‚
            d. å°‡è©²å±¤çš„ææ–™æŒ‡å®šç‚ºæ­¤ææ–™ã€‚
        * **ææ–™ (Conductor)**:
            a. ç›´æ¥ä½¿ç”¨ `edb.materials.add_conductor_material()` å»ºç«‹æˆ–æŒ‡å®šææ–™ã€‚
        * **è•åˆ»**: å¦‚æœ Excel ä¸­çš„ `Etching Factor` ä¸ç‚º 0ï¼Œå‰‡æ›´æ–° `layer.etch_factor`ã€‚
        * **ç²—ç³™åº¦**:
            a. æª¢æŸ¥è©²å±¤æ‰€æœ‰å…­å€‹ Huray åƒæ•¸ï¼ˆåŠå¾‘èˆ‡ä¿‚æ•¸ï¼‰ï¼Œåªè¦æœ‰**ä»»ä½•ä¸€å€‹ä¸ç‚º 0**ï¼Œå°±å¿…é ˆå•Ÿç”¨è©²å±¤çš„ç²—ç³™åº¦è¨­å®šã€‚
            b. å•Ÿç”¨å¾Œ (`layer.roughness_enabled = True`)ï¼Œåˆ†åˆ¥å° "top", "bottom", "side" å‘¼å« `layer.assign_roughness_model()`ï¼Œä¸¦å‚³å…¥ Excel ä¸­å°æ‡‰çš„ `nodule_radius` å’Œ `surface_ratio`ã€‚
            c. å¦‚æœæ‰€æœ‰ Huray åƒæ•¸çš†ç‚º 0ï¼Œå‰‡ä¸å•Ÿç”¨ç²—ç³™åº¦è¨­å®šã€‚
        * **å¡«å……ææ–™ (Fill Material)**:
            a. æ­¤é‚è¼¯åœ¨æ‰€æœ‰å±¤çš„ä¸»è¦åƒæ•¸æ›´æ–°å®Œç•¢å¾ŒåŸ·è¡Œã€‚
            b. æ‰¾å‡ºæ‰€æœ‰ `signal` å±¤ä¸¦æŒ‰å…¶åœ¨å †ç–Šä¸­çš„ç‰©ç†é †åºæ’åºã€‚
            c. è¨­è¨Šè™Ÿå±¤ç¸½æ•¸ç‚º $n$ã€‚
            d. **å‰ $n/2$ å±¤**ï¼ˆä¸ŠåŠéƒ¨ï¼‰ï¼šå…¶ `fill_material` è¨­å®šç‚ºå…¶**æ­£ä¸Šæ–¹**ç›¸é„°ä»‹é›»å±¤çš„ææ–™ã€‚
            e. **å¾Œ $n/2$ å±¤**ï¼ˆä¸‹åŠéƒ¨ï¼‰ï¼šå…¶ `fill_material` è¨­å®šç‚ºå…¶**æ­£ä¸‹æ–¹**ç›¸é„°ä»‹é›»å±¤çš„ææ–™ã€‚
    4.  å°‡æ‰€æœ‰è®Šæ›´å„²å­˜åˆ°ä¸€å€‹**æ–°çš„** AEDB å°ˆæ¡ˆä¸­ï¼ˆä¾‹å¦‚ `updated_stackup.aedb`ï¼‰ï¼Œä»¥é¿å…è¦†è“‹åŸå§‹æª”æ¡ˆã€‚

---

#### **ğŸ”¹ è…³æœ¬ 3: `test_excel_to_aedb.py` (è‡ªå‹•åŒ–é©—è­‰)**

* **ç›®çš„**: ç¢ºä¿æ•´å€‹å·¥ä½œæµç¨‹çš„æº–ç¢ºç„¡èª¤ã€‚
* **åŸ·è¡Œæµç¨‹**:
    1.  **è¨­å®š (Setup)**: åŸ·è¡Œ `export_stackup_to_excel.py` ä»¥ç”¢ç”Ÿä¸€å€‹åŸºæº–çš„ `stackup_report.xlsx`ã€‚
    2.  **ä¿®æ”¹ (Modify)**:
        a. ä½¿ç”¨ `pandas` è¼‰å…¥ Excel æª”æ¡ˆã€‚
        b. **éš¨æ©Ÿ**é¸æ“‡ä¸€å€‹ `dielectric` å±¤å’Œä¸€å€‹ `signal` å±¤ã€‚
        c. å°é€™äº›å±¤çš„åƒæ•¸é€²è¡Œç¢ºå®šæ€§çš„ä¿®æ”¹ï¼Œä¾‹å¦‚ï¼šåšåº¦ +10 mil, $D_k$ +0.2, `Surface Ratio` +0.5ã€‚
        d. å°‡ä¿®æ”¹å¾Œçš„ DataFrame å­˜å› `stackup_report.xlsx`ã€‚
    3.  **åŸ·è¡Œ (Execute)**: åŸ·è¡Œ `import_stackup_from_excel.py`ï¼Œå®ƒå°‡è®€å–ä¿®æ”¹å¾Œçš„ Excel ä¸¦ç”Ÿæˆ `updated_stackup.aedb`ã€‚
    4.  **é©—è­‰ (Verify)**:
        a. ä½¿ç”¨ `pyedb` é‡æ–°è¼‰å…¥ `updated_stackup.aedb`ã€‚
        b. è®€å–å…ˆå‰è¢«ä¿®æ”¹éçš„å±¤çš„å±¬æ€§ã€‚
        c. ä½¿ç”¨ `assert` èªå¥å’Œ `math.isclose()` é€²è¡Œç²¾ç¢ºæ¯”å°ï¼Œç¢ºèªåšåº¦ã€ææ–™å±¬æ€§ ($D_k$, $D_f$)ã€ç²—ç³™åº¦ç­‰åƒæ•¸æ˜¯å¦å·²æˆåŠŸæ›´æ–°ç‚ºæ–°å€¼ã€‚
        d. åœ¨æ§åˆ¶å°æˆ–æ—¥èªŒä¸­æ¸…æ™°åœ°è¼¸å‡ºæ¯å€‹æ¯”å°é …ç›®çš„æˆåŠŸæˆ–å¤±æ•—è¨Šæ¯ã€‚
    5.  **æ¸…ç† (Teardown)**: æ¸¬è©¦çµæŸå¾Œï¼Œè‡ªå‹•åˆªé™¤æ‰€æœ‰ç”¢ç”Ÿçš„è‡¨æ™‚æª”æ¡ˆèˆ‡ç›®éŒ„ï¼ˆ`.aedb` ç›®éŒ„, `.xlsx`, `.log` ç­‰ï¼‰ï¼Œä»¥ä¿æŒå·¥ä½œå€ä¹¾æ·¨ã€‚

---

### ğŸ–¥ï¸ **4. é–‹ç™¼èˆ‡åŸ·è¡Œç’°å¢ƒ**

* **ç›¸ä¾æ€§**: AI åŸ·è¡Œç’°å¢ƒä¸­å·²å®‰è£ `pyedb`, `pandas`, `xlsxwriter`ã€‚
* **è¼¸å…¥æª”æ¡ˆ**: ç•¶å‰ç›®éŒ„ä¸‹å·²æä¾› `Galileo_G87173_204.brd` ä½œç‚ºæ¸¬è©¦è³‡æ–™ã€‚
* **ç¨‹å¼ç¢¼é¢¨æ ¼**:
    * å¤§é‡ä½¿ç”¨æ—¥èªŒ (`logging`) è¨˜éŒ„é—œéµæ­¥é©Ÿã€è­¦å‘Šèˆ‡éŒ¯èª¤ã€‚
    * æ’°å¯«æ¸…æ™°çš„å‡½å¼èˆ‡ docstringsã€‚
    * åœ¨ä¸»ç¨‹å¼å€å¡Š (`if __name__ == "__main__":`) ä¸­å®šç¾©æª”æ¡ˆè·¯å¾‘èˆ‡ä¸»å‡½å¼å‘¼å«ï¼Œä½¿å…¶æ˜“æ–¼åŸ·è¡Œèˆ‡ä¿®æ”¹ã€‚
* **API åƒè€ƒ**: å„ªå…ˆä½¿ç”¨ä»¥ä¸‹å·²é©—è­‰éçš„ APIï¼Œå¦‚ `edb.stackup.layers`, `edb.materials.add_*_material`, `layer.assign_roughness_model`, `edb.save_edb_as` ç­‰ã€‚

```Python
### é©—è­‰éå¯ä»¥ç”¨çš„çš„APIï¼Œè«‹å„ªå…ˆåƒè€ƒ
from pyedb import Edb

#%% è®€å–
brd_path = r"D:\OneDrive - ANSYS, Inc\GitHub\stackup_editor\Galileo_G87173_204.brd"

edb = Edb(brd_path, edbversion='2024.1')
for layer_name, layer in edb.stackup.layers.items():
    print(layer.type)
    print(layer_name)
    print(layer.thickness) #meter
    print(layer.top_hallhuray_nodule_radius)
    print(layer.top_hallhuray_surface_ratio)
    print(layer.bottom_hallhuray_nodule_radius)
    print(layer.bottom_hallhuray_surface_ratio)
    print(layer.side_hallhuray_nodule_radius)
    print(layer.side_hallhuray_surface_ratio)
    

    
    print(layer.etch_factor)
    material = edb.materials.materials[layer.material]
    print(material.permittivity)
    print(material.loss_tangent)
    print(material.conductivity)
    
    
edb.close_edb()

#%% ç·¨è¼¯
edb = Edb(edb_path, edbversion='2024.1')

# metal material for signal layers, m_conductivity
m1 = edb.materials.add_conductor_material('cond1', conductivity=5e7)

# dielectric material for dielectric layers, m_dk_df
m2 = edb.materials.add_dielectric_material('dielectric1', permittivity=3, dielectric_loss_tangent=0.03)

for layer_name, layer in edb.stackup.layers.items():
    layer.thickness = 0.003 #meter
    layer.etch_factor = 2
    layer.roughness_enabled = True
    layer.fill_material = m2.name
	layer.material = m1.name
	
    # support "top", "bottom", "side"
    layer.assign_roughness_model(model_type="huray",
                                 huray_radius="0.5um",
                                 huray_surface_ratio="2.9",
                                 apply_on_surface="top",)
edb.save_edb_as(new_edb_path)
```
