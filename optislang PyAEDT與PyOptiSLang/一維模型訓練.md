## 一維模型（Signal MOP）訓練

optiSLang 是一個功能強大的優化與敏感度分析工具，常用於訓練與優化數學模型，以達到特定的工程目標。除了可用於靜態輸出，如固定頻率下的電感值計算，它也支援一維（1D）動態輸出模型，用於描述輸出值隨時間或頻率的變化，這對於需要進行頻率響應分析的應用尤其重要。

### 功能

本例透過 Python 程式產生一組 sine 函數波形資料，並將其轉換為 optiSLang 支援的格式，作為 1D MOP（Meta Model of Optimal Prognosis）訓練的輸出資料。若參數不合法，則直接回傳 `None`，以避免訓練過程失敗。

### 流程架構

1. 檢查是否在 optiSLang 正式執行環境中。
2. 若非正式執行，則設置預設參數 `w=1`（頻率）、`a=1`（振幅）。
3. 若 `w <= 0`，輸入不合法，則回傳 `None`。
4. 建立 x 軸數據點（0 \~ 9.99，每 0.01 一點）。
5. 使用 `y = a * sin(w * x)` 產生 y 值。
6. 呼叫 `list_2_variant_xy_data(y, x)` 將資料轉為 optiSLang 可接受的格式。

### 補充說明

* `list_2_variant_xy_data` 是 pyvariant 套件中專為 optiSLang 設計的函數，將列表資料轉為 Signal MOP 所需的變異型別資料格式。
* 回傳 `None` 而非 `False` 是因為 optiSLang 對資料型別有嚴格要求，避免因資料不合法造成模型訓練錯誤。
* 此程式碼可用於模擬任何與頻率相關的模型行為，例如電感值隨頻率變化的特性分析。
### 注意事項

這裡的 `pyvariant` 並不是 PyPI 上的 `pyvariant` 套件，而是 **optiSLang 安裝目錄底下的 pyvariant**，其路徑如下：

```
C:\Program Files\ANSYS Inc\v251\optiSLang\lib\python-modules\pyvariant.cp312-win_amd64.pyd
```

* 如果你使用的是 **optiSLang 內建的 Python3 環境**，預設便會載入該 pyvariant 模組。

![2025-07-25_20-56-26](/assets/2025-07-25_20-56-26.png)
* 如果你使用的是其他 Python 環境，請在程式碼最前面加入以下語句：

```python
import os
import sys
from pathlib import Path

BASE = Path(r"C:\Program Files\ANSYS Inc\v251\optiSLang")
DLL_PATHS = [
    BASE,
    BASE / "lib",
    BASE / "lib" / "python3.10" / "DLLs"
]

for p in DLL_PATHS:
    os.add_dll_directory(str(p))

sys.path.append(str(BASE / "lib" / "python-modules"))
import pyvariant
```
> 📌 請視實際 optiSLang 安裝路徑調整上述路徑設定。


### 範例程式

```python
from pyvariant import list_2_variant_xy_data
from math import sin

# 檢查 'OSL_REGULAR_EXECUTION' 是否存在於區域變數中
# 這是 optiSLang 的系統變數，用於判斷腳本是在「正式執行 (Solver run)」還是「測試/編輯 (Interactive)」模式
if not 'OSL_REGULAR_EXECUTION' in locals(): 
    OSL_REGULAR_EXECUTION = False

# 如果不是正式執行模式（例如在編輯器中按 Run Script 測試時）
# 手動設定輸入變數 w (角頻率) 和 a (振幅) 的預設值，避免報錯
if not OSL_REGULAR_EXECUTION:
    w = 1.0
    a = 1.0

# 防呆機制：如果角頻率 w 小於等於 0，則不進行計算，結果設為 None
if w <= 0:
    variant_y = None
else:
    # 產生 x 軸數據（時間序列）：0 到 9.99，步階為 0.01，共 1000 個點
    x = [0.01 * i for i in range(1000)]

    # 產生 y 軸數據（正弦波）：根據振幅 a 和角頻率 w 計算
    y = [a * sin(w * i) for i in x]

    # 將 Python 的 list 數據轉換為 optiSLang 專用的 Variant XY 數據格式
    # 這通常是為了將波形傳遞給後續的訊號處理節點
    variant_y = list_2_variant_xy_data(y, x)
    
    # 將當前設計點的參數與結果寫入 CSV 檔案（用於除錯或記錄）
    # DESIGN_NO 是 optiSLang 的內建變數，代表當前的設計點編號 (Design ID)
    with open(f'd:/demo/{DESIGN_NO}.csv', 'w') as f:
        f.write(f'{a}, {w}\n')      # 寫入輸入參數 a 和 w
        f.write(str(x) + '\n')      # 寫入 x 軸數據
        f.write(str(y) + '\n')      # 寫入 y 軸數據
```

### 實作示意與進階操作

#### 1. 一維模型輸入設置畫面

![2024-08-21\_12-22-47](/assets/2024-08-21_12-22-47.png)

#### 2. 加入 Sensitivity 分析

* 可分析輸入參數（如 w, a）對於整體輸出的貢獻度。

![2024-08-21\_12-24-23](/assets/2024-08-21_12-24-23.png)


![2024-08-21\_12-25-24](/assets/2024-08-21_12-25-24.png)


![2024-08-21\_13-00-21](/assets/2024-08-21_13-00-21_o5vk5q2ih.png)


#### 3. 執行訓練並檢視訓練結果

* 訓練完成後，可在 optiSLang 中檢視模型行為預測曲線。可以看到因為預設100個樣本當中許多違反規範導致Failed。因此訓練結果，黑線在x較大的區域下降。代表這一區間訊號預測準確度不佳。
![2025-05-31_11-18-10](/assets/2025-05-31_11-18-10.png)

![2025-05-31_11-18-42](/assets/2025-05-31_11-18-42.png)


#### 4. 增加點數到500
黑色線貼近100，代表預測品質良好

![2025-05-31_11-17-02](/assets/2025-05-31_11-17-02.png)